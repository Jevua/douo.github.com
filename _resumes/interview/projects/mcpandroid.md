---
title: McpAndroid
date: '2017-10-30'
description:
type: draft ## 移除这个字段，笔记才会公开发布
---

移动理赔处理平台（简称 Mcp），是原人保内部最大的移动平台--移动查勘定损系统的第二代产品。Mcp 主要提供理赔人员现场办案使用，核心业务是车险，主要功能包括：拍照，录音，OCR，Gis 调度，离线使用等。

Mcp 基于 cordova 使用 Hybird 技术，界面及大部分业务代码由前端实现，Android 起到一个容器的作用。功能模块以插件的形式进行组织。对前端只暴露了最外层插件接口层。

我参与了项目从 0 到 1 的组建过程，团队从最初 3 人扩展到 20 多人，并在连续 4 个月的高强度工作下完成一期上海试点目标。我主要负责框架的设计，基础功能的开发，包括页面的管理、跨页面高效传输数据、gb 级 sqlite 数据的组织和使用。还有需求评估，为组内成员分配任务，及制定开发规范和流程等工作。

接口主要分为数据接口和功能接口两类。

数据接口包括

- 离线接口
- 在线接口

- 呼叫及通讯录
- Storage，加密的数据序列化功能
- 录音，
- OCR，
- Gis 
- 相机，
- 设置，对 SharedPreference 进行封装，提供一些便利接口，震动，铃声选择，比如更改 host，及时更新 url。


这里的插件概念应该是 cordova 插件的子集。有些插件并没有给前端提供接口。比如用于解密 html、js、css 的插件。改进了 cordova 插件的执行方式，利用运行时注解和反射来简化代码。

另外还有包括 H5 的管理模块，负责 h5 的版本更新。及文件的解密。


## Cordova


当时也有一些可选方案，

- HBuilder，太小，不开源，不清楚使用协议。
- React Native，太新，没时间采坑。


https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&cad=rja&uact=8&ved=0ahUKEwi2y92Ro5jXAhXIilQKHWmCAKYQFggoMAA&url=https%3A%2F%2Fgithub.com%2Ftkyaji%2Fcordova-plugin-crypt-file&usg=AOvVaw0SvQaH2H51j5rRU6rrvzLR

## 最大的问题

前端反馈的最大问题就是回调地狱了。改造成 Observable 通过 RxJx 来解决。flatmap 就是解决这问题的良药，再升级到 ES6 引入箭头符号，那代码量一定能简洁很多。不过因为前端的业务量确实太多了，所以一直没有推行。


## 基础工作

搭建 gitlab 服务器，和持续集成。docker。

## 生成 Doclet

我还做了个 doclet 用于将生成进口文档。将特定格式的 javadoc 转换为 md，然后用 jkelly 将 md 转成静态页面 html。

## OCR

文通

- 驾驶证
- 行驶证/ vin 识别
- 身份证
- 银行卡

## Storage

为前端提供持久化功能，对存储的数据进行加密。可以有多个 Storage 实例，这样设计的目的是为了每个案件都独立一个 Storage。

Storage 有两层缓存，放入 IO 的时候，同时会在内存缓存，用的是  LruCache

Storage 另外一个目的就是通过支持将 json 存放在内存中还提供跨页面传递对象的能力。

Lrucache，队列。

每个对象携带有一个计数器。比如说 10 秒，表示说该对象十秒后会被加密写入磁盘。如果这个时间内该对象又被使用。那么

最后一位就是最先放进去的。

### ModifiedLryCache



## DBFlow

加了一层，用于运行时，动态 remap db 名称。

主要通过复写 Application 的 `getDatabasePath` 和 `openOrCreateDatabase` 方法来实现的。

## 代码质量

- 会对项目做静态分析，好像用的是 checkmarx 的产品
- 加壳，梆梆安全

## 遗憾

这个平台挺可惜的，当时为了赶工期，欠下了很多技术债务。可惜后来没有时间还债。


## 工时计算公式

二代移动android客户端查勘工时计算方法
 
1.4S店车组发布：
车组4S店定损参考价格=车组4S店本地工时数喷漆项目除外)*4S店地区品牌系数(地区下按品牌维护的系数)
 
2.市场车组发布时：
车组市场定损参考价格=车组市场本地工时数*修理厂类型系数*地区品牌系数
注：计算市场工时时，如果选择的修理厂是4S店，使用一类厂修理厂的系数。
 
3.4S店车组未发布：
等级定损参考价格=4S等级本地工时数*修理厂类型系数*地区品牌系数
4.市场车组未发布：
等级定损参考价格=市场等级本地工时数*修理厂类型系数*地区品牌系数
注：计算市场工时时，如果选择的修理厂是4S店，使用一类厂修理厂的系数。
 
 
 
二代移动android客户端查勘工时价格计算方法
 
1.4S店车组发布：
车组4S店定损参考价格=车组4S店本地工时数*标准工时单价(默认10（写死，不可调整），喷漆项目除外)*4S店地区品牌系数(地区下按品牌维护的系数)*喷漆系数（只限喷漆项目）*
 
 
2.市场车组发布时：
车组市场定损参考价格=车组市场本地工时数*标准工时单价(默认10（写死，不可调整），喷漆项目除外)*修理厂类型系数*地区品牌系数*喷漆系数（只限喷漆项目）
注：计算市场工时时，如果选择的修理厂是4S店，使用一类厂修理厂的系数。
 
3.4S店车组未发布：
等级定损参考价格=4S等级本地工时数*标准工时单价(默认10（写死，不可调整），喷漆项目除外)*修理厂类型系数*地区品牌系数*喷漆系数（只限喷漆项目）
 
4.市场车组未发布：
等级定损参考价格=市场等级本地工时数*标准工时单价(默认10（写死，不可调整），喷漆项目除外)*修理厂类型系数*地区品牌系数*喷漆系数（只限喷漆项目）
注：计算市场工时时，如果选择的修理厂是4S店，使用一类厂修理厂的系数。
 
总注：（以上是安卓端计算返回工时的数据和工时价格数据  h5端对工时数据没做处理 但是对工时价格数据做了处理  如 在 此基础上 *工时折扣系数 等，详细问下前端 ）
